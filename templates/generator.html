{% extends "base.html" %}

{% block title %}Content Generator - English Course Builder{% endblock %}

{% block content %}
<div class="container my-5">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('dashboard') }}">Dashboard</a>
                    </li>
                    <li class="breadcrumb-item active" id="topicBreadcrumb">Content Generator</li>
                </ol>
            </nav>
            <h1 class="display-5 mb-3" id="topicTitle">
                <i class="fas fa-magic me-2"></i>
                Content Generator
            </h1>
        </div>
    </div>

    <!-- Content Generation Form -->
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card bg-dark border-secondary h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        Generation Settings
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Content Type Selection -->
                    <div class="mb-3">
                        <label for="contentType" class="form-label">Content Type</label>
                        <select class="form-select" id="contentType">
                            <option value="mcq">Multiple Choice Questions (MCQ)</option>
                            <option value="cheat_sheet">Cheat Sheet</option>
                            <option value="drag_drop">Drag & Drop Activities</option>
                            <option value="textual">Textual Questions</option>
                            <option value="listening">Listening Exercises</option>
                        </select>
                    </div>

                    <!-- Temperature Setting -->
                    <div class="mb-3">
                        <label for="temperature" class="form-label">
                            Temperature 
                            <span class="badge bg-secondary" id="temperatureValue">0.7</span>
                        </label>
                        <input type="range" class="form-range" id="temperature" 
                               min="0" max="1" step="0.1" value="0.7"
                               oninput="updateTemperatureValue(this.value)">
                        <div class="form-text">
                            Lower values (0.1-0.3) for more focused content, higher values (0.7-1.0) for more creative content.
                        </div>
                    </div>

                    <!-- Prompt Template -->
                    <div class="mb-3">
                        <label for="promptTemplate" class="form-label">Prompt Template</label>
                        <textarea class="form-control" id="promptTemplate" rows="8" 
                                  placeholder="Enter your prompt template here..."></textarea>
                        <div class="form-text">
                            Edit the prompt template to customize the generated content.
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <button type="button" class="btn btn-primary w-100" id="generateBtn" onclick="generateContent()">
                        <i class="fas fa-magic me-2"></i>
                        Generate Content
                    </button>
                </div>
            </div>
        </div>

        <!-- Generated Content Display -->
        <div class="col-lg-6 mb-4">
            <div class="card bg-dark border-secondary h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-file-alt me-2"></i>
                        Generated Content
                    </h5>
                    <div class="btn-group" id="exportButtons" style="display: none;">
                        <button type="button" class="btn btn-success btn-sm" onclick="exportToExcel()">
                            <i class="fas fa-file-excel me-2"></i>
                            Excel
                        </button>
                        <button type="button" class="btn btn-info btn-sm" onclick="exportToJson()">
                            <i class="fas fa-file-code me-2"></i>
                            JSON
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="contentDisplay" class="text-center text-muted">
                        <i class="fas fa-lightbulb fa-3x mb-3 opacity-50"></i>
                        <p>Click "Generate Content" to create educational materials using AI.</p>
                    </div>
                    
                    <!-- Loading Spinner -->
                    <div id="loadingSpinner" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted">Generating content with AI...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentTopic = null;
let generatedContent = null;
let currentContentType = 'mcq';

// Load topic data on page load
document.addEventListener('DOMContentLoaded', function() {
    const topicId = '{{ topic_id }}';
    loadTopicData(topicId);
});

function loadTopicData(topicId) {
    if (typeof topics === 'undefined') {
        alert('Topics data not found. Please check if topics.js is loaded correctly.');
        window.location.href = '/';
        return;
    }
    
    currentTopic = topics.find(t => t.id === topicId);
    if (!currentTopic) {
        alert('Topic not found.');
        window.location.href = '/';
        return;
    }
    
    // Update page elements
    document.getElementById('topicTitle').innerHTML = `
        <i class="${currentTopic.icon} me-2"></i>
        ${currentTopic.title}
    `;
    document.getElementById('topicBreadcrumb').textContent = currentTopic.title;
    document.getElementById('temperature').value = currentTopic.temperature;
    document.getElementById('temperatureValue').textContent = currentTopic.temperature;
    document.getElementById('promptTemplate').value = currentTopic.prompt;
}

function updateTemperatureValue(value) {
    document.getElementById('temperatureValue').textContent = value;
}

function generateContent() {
    const apiKey = localStorage.getItem('gemini_api_key');
    if (!apiKey) {
        alert('Please set your Gemini API key in the dashboard first.');
        window.location.href = '/';
        return;
    }
    
    const prompt = document.getElementById('promptTemplate').value.trim();
    if (!prompt) {
        alert('Please enter a prompt template.');
        return;
    }
    
    const temperature = parseFloat(document.getElementById('temperature').value);
    currentContentType = document.getElementById('contentType').value;
    
    // Show loading state
    document.getElementById('generateBtn').disabled = true;
    document.getElementById('generateBtn').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
    document.getElementById('loadingSpinner').style.display = 'block';
    document.getElementById('contentDisplay').style.display = 'none';
    document.getElementById('exportButtons').style.display = 'none';
    
    // Make API call
    fetch('/api/generate-content', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            api_key: apiKey,
            prompt: prompt,
            temperature: temperature,
            content_type: currentContentType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            generatedContent = data.content;
            displayGeneratedContent(data.content, data.content_type);
            document.getElementById('exportButtons').style.display = 'inline-block';
            
            // Show sample content message if applicable
            if (data.is_sample) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-warning mt-3';
                alertDiv.innerHTML = `
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Demo Mode:</strong> ${data.message}
                `;
                document.getElementById('contentDisplay').prepend(alertDiv);
            }
        } else {
            throw new Error(data.error || 'Failed to generate content');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('contentDisplay').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error: ${error.message}
            </div>
        `;
        document.getElementById('contentDisplay').style.display = 'block';
    })
    .finally(() => {
        // Reset button state
        document.getElementById('generateBtn').disabled = false;
        document.getElementById('generateBtn').innerHTML = '<i class="fas fa-magic me-2"></i>Generate Content';
        document.getElementById('loadingSpinner').style.display = 'none';
    });
}

function displayGeneratedContent(content, contentType) {
    const displayDiv = document.getElementById('contentDisplay');
    let html = '';
    
    switch (contentType) {
        case 'mcq':
            html = formatMCQContent(content);
            break;
        case 'cheat_sheet':
            html = formatCheatSheetContent(content);
            break;
        case 'drag_drop':
            html = formatDragDropContent(content);
            break;
        case 'textual':
            html = formatTextualContent(content);
            break;
        case 'listening':
            html = formatListeningContent(content);
            break;
        default:
            html = '<pre>' + JSON.stringify(content, null, 2) + '</pre>';
    }
    
    displayDiv.innerHTML = html;
    displayDiv.style.display = 'block';
}

function formatMCQContent(content) {
    let html = `<h5 class="mb-3">${content.title || 'Multiple Choice Questions'}</h5>`;
    
    if (content.questions) {
        content.questions.forEach((q, index) => {
            html += `
                <div class="mb-4 p-3 border rounded">
                    <h6 class="fw-bold">Question ${index + 1}</h6>
                    <p>${q.question}</p>
                    <div class="ms-3">
                        ${q.options ? q.options.map(option => `<div class="mb-1">${option}</div>`).join('') : ''}
                    </div>
                    <div class="mt-2">
                        <small class="text-success"><strong>Answer:</strong> ${q.correct_answer}</small>
                        ${q.explanation ? `<br><small class="text-muted">${q.explanation}</small>` : ''}
                    </div>
                </div>
            `;
        });
    }
    
    return html;
}

function formatCheatSheetContent(content) {
    let html = `<h5 class="mb-3">${content.title || 'Cheat Sheet'}</h5>`;
    
    if (content.sections) {
        content.sections.forEach(section => {
            html += `
                <div class="mb-4">
                    <h6 class="fw-bold text-primary">${section.heading}</h6>
                    <ul class="list-unstyled ms-3">
                        ${section.content ? section.content.map(item => `<li>• ${item}</li>`).join('') : ''}
                    </ul>
                </div>
            `;
        });
    }
    
    if (content.quick_tips) {
        html += `
            <div class="mt-4 p-3 bg-info bg-opacity-10 border border-info rounded">
                <h6 class="fw-bold text-info">Quick Tips</h6>
                <ul class="list-unstyled mb-0">
                    ${content.quick_tips.map(tip => `<li>💡 ${tip}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    return html;
}

function formatDragDropContent(content) {
    let html = `
        <h5 class="mb-3">${content.title || 'Drag & Drop Activity'}</h5>
        <p class="text-muted mb-3">${content.instructions || ''}</p>
    `;
    
    if (content.items) {
        html += '<div class="row">';
        html += '<div class="col-6"><h6>Items to Match</h6>';
        content.items.forEach((item, index) => {
            html += `<div class="p-2 mb-2 bg-primary bg-opacity-25 rounded">${item.left}</div>`;
        });
        html += '</div>';
        
        html += '<div class="col-6"><h6>Correct Matches</h6>';
        content.items.forEach((item, index) => {
            html += `<div class="p-2 mb-2 bg-success bg-opacity-25 rounded">${item.right}</div>`;
        });
        html += '</div></div>';
    }
    
    return html;
}

function formatTextualContent(content) {
    let html = `<h5 class="mb-3">${content.title || 'Textual Questions'}</h5>`;
    
    if (content.questions) {
        content.questions.forEach((q, index) => {
            html += `
                <div class="mb-4 p-3 border rounded">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-bold mb-0">Question ${index + 1}</h6>
                        <span class="badge bg-secondary">${q.type || 'Question'}</span>
                    </div>
                    <p>${q.question}</p>
                    ${q.sample_answer ? `<div class="mt-2"><small class="text-muted"><strong>Sample Answer:</strong> ${q.sample_answer}</small></div>` : ''}
                    ${q.guidelines ? `<div class="mt-2"><small class="text-muted"><strong>Guidelines:</strong> ${q.guidelines}</small></div>` : ''}
                </div>
            `;
        });
    }
    
    return html;
}

function formatListeningContent(content) {
    let html = `
        <h5 class="mb-3">${content.title || 'Listening Exercise'}</h5>
        <div class="alert alert-info mb-3">
            <strong>Audio Description:</strong> ${content.audio_description || 'No description provided'}
        </div>
    `;
    
    if (content.pre_listening) {
        html += `
            <div class="mb-4">
                <h6 class="fw-bold text-warning">Pre-listening Questions</h6>
                <ul>
                    ${content.pre_listening.map(q => `<li>${q}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    if (content.while_listening) {
        html += `
            <div class="mb-4">
                <h6 class="fw-bold text-primary">While Listening</h6>
                ${content.while_listening.map((q, index) => `
                    <div class="mb-3 p-3 border rounded">
                        <p><strong>Q${index + 1}:</strong> ${q.question}</p>
                        ${q.options ? `<div class="ms-3">${q.options.map(opt => `<div>${opt}</div>`).join('')}</div>` : ''}
                        ${q.correct_answer ? `<small class="text-success"><strong>Answer:</strong> ${q.correct_answer}</small>` : ''}
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    if (content.post_listening) {
        html += `
            <div class="mb-4">
                <h6 class="fw-bold text-success">Post-listening Discussion</h6>
                <ul>
                    ${content.post_listening.map(q => `<li>${q}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    return html;
}

function exportToExcel() {
    if (!generatedContent) {
        alert('No content to export. Please generate content first.');
        return;
    }
    
    const exportData = {
        content: generatedContent,
        content_type: currentContentType,
        topic_title: currentTopic ? currentTopic.title : 'English Course Content'
    };
    
    exportFile('/api/export-excel', 'xlsx', 'Excel');
}

function exportToJson() {
    if (!generatedContent) {
        alert('No content to export. Please generate content first.');
        return;
    }
    
    const exportData = {
        content: generatedContent,
        content_type: currentContentType,
        topic_title: currentTopic ? currentTopic.title : 'English Course Content'
    };
    
    exportFile('/api/export-json', 'json', 'JSON');
}

function exportFile(endpoint, extension, formatName) {
    const exportData = {
        content: generatedContent,
        content_type: currentContentType,
        topic_title: currentTopic ? currentTopic.title : 'English Course Content'
    };
    
    fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(exportData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Failed to export to ${formatName}`);
        }
        return response.blob();
    })
    .then(blob => {
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `${currentTopic.title.replace(/\s+/g, '_')}_${currentContentType}.${extension}`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Show success message
        if (window.appUtils && window.appUtils.showAlert) {
            window.appUtils.showAlert(`${formatName} file downloaded successfully!`, 'success', 3000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert(`Failed to export to ${formatName}: ` + error.message);
    });
}
</script>
{% endblock %}
